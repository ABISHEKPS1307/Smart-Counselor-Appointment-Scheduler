# =============================================================================
# Docker Compose Configuration for Local Development
# 
# This file sets up the application with a local SQL Server instance for testing.
# For production, use Azure SQL Database instead.
# 
# Usage:
#   docker-compose up -d
#   docker-compose down
# =============================================================================

version: '3.8'

services:
  # SQL Server Database (for local testing only)
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: counselor-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong!Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql
      - ./sql:/docker-entrypoint-initdb.d
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong!Passw0rd -Q "SELECT 1"
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - app-network

  # Node.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: counselor-app
    environment:
      - NODE_ENV=development
      - PORT=8080
      - SQL_SERVER=db
      - SQL_DATABASE=CounselorScheduler
      - SQL_USER=sa
      - SQL_PASSWORD=YourStrong!Passw0rd
      - SQL_ENCRYPT=false
      - SQL_TRUST_SERVER_CERTIFICATE=true
      - JWT_SECRET=local-dev-secret-key-change-in-production
      - JWT_EXPIRES_IN=1h
      # Azure OpenAI - Replace with your values
      - AZURE_OPENAI_ENDPOINT=https://your-openai-resource.openai.azure.com/
      - AZURE_OPENAI_API_KEY=your-openai-api-key
      - AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4
      - AZURE_OPENAI_API_VERSION=2023-05-15
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./public:/app/public
    networks:
      - app-network
    restart: unless-stopped

volumes:
  mssql-data:
    driver: local

networks:
  app-network:
    driver: bridge

# =============================================================================
# Setup Instructions:
# =============================================================================
# 
# 1. Make sure Docker Desktop is running
# 
# 2. Update environment variables in this file:
#    - Set your Azure OpenAI credentials
# 
# 3. Start the services:
#    docker-compose up -d
# 
# 4. Wait for database to be ready (about 30 seconds)
# 
# 5. Initialize the database schema:
#    docker exec -it counselor-db /opt/mssql-tools/bin/sqlcmd \
#      -S localhost -U sa -P "YourStrong!Passw0rd" \
#      -Q "CREATE DATABASE CounselorScheduler"
#    
#    docker exec -it counselor-db /opt/mssql-tools/bin/sqlcmd \
#      -S localhost -U sa -P "YourStrong!Passw0rd" \
#      -d CounselorScheduler -i /docker-entrypoint-initdb.d/schema.sql
# 
# 6. Access the application:
#    http://localhost:8080
# 
# 7. View logs:
#    docker-compose logs -f app
# 
# 8. Stop the services:
#    docker-compose down
# 
# =============================================================================
