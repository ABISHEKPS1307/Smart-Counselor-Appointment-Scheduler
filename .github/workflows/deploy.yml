name: Deploy to Azure Container Apps

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ACR_NAME: counselorsch123acr
  IMAGE_NAME: counselor-app
  RESOURCE_GROUP: CloudProjectNew
  CONTAINER_APP_NAME: counselor-app

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Update version.json
        run: |
          echo "Updating version file with build info..."
          node scripts/update-version.js
          echo "Version file updated:"
          cat public/version.json
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ env.ACR_NAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and Push Docker Image
        run: |
          # Build image
          echo "Building Docker image..."
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          # Push to ACR
          echo "Pushing to ACR..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          echo "‚úÖ Image pushed successfully"
      
      - name: Deploy to Container App
        run: |
          echo "üöÄ Deploying to Container App..."
          
          # Set secrets (doesn't create a new revision)
          echo "Setting secrets..."
          az containerapp secret set \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --secrets \
              sql-password="${{ secrets.SQL_PASSWORD }}" \
              jwt-secret="${{ secrets.JWT_SECRET }}"
          
          echo "‚úÖ Secrets updated"
          
          # Single update with image + all env vars (creates only ONE revision)
          echo "Updating container app..."
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars \
              NODE_ENV=production \
              PORT=8080 \
              SQL_SERVER=scmainserver.database.windows.net \
              SQL_DATABASE=sc-db \
              SQL_USER=adminuser \
              SQL_PASSWORD=secretref:sql-password \
              SQL_ENCRYPT=true \
              SQL_TRUST_SERVER_CERTIFICATE=false \
              JWT_SECRET=secretref:jwt-secret \
              JWT_EXPIRES_IN=1h \
              AZURE_OPENAI_ENDPOINT=https://placeholder.openai.azure.com/ \
              AZURE_OPENAI_API_KEY=placeholder
          
          # Restart to apply changes
          echo "Restarting container app..."
          LATEST_REVISION=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.latestRevisionName \
            -o tsv)
          
          az containerapp revision restart \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision $LATEST_REVISION
          
          echo "‚úÖ Container App deployed successfully"
      
      - name: Get Container App URL
        id: get-url
        run: |
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "app_url=https://$FQDN" >> $GITHUB_OUTPUT
          echo "Container App URL: https://$FQDN"
      
      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 45 seconds for new revision to start..."
          sleep 45
      
      - name: Health Check
        run: |
          APP_URL="${{ steps.get-url.outputs.app_url }}"
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          echo "Testing health endpoint: $APP_URL/api/health"
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT+1))
            echo "[$ATTEMPT/$MAX_ATTEMPTS] Checking..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${APP_URL}/api/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo ""
              echo "========================================" 
              echo "üéâ DEPLOYMENT SUCCESSFUL!"
              echo "========================================"
              echo "App URL: $APP_URL"
              echo "Health: $APP_URL/api/health"
              echo "API Docs: $APP_URL/api-docs"
              echo "Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
              echo "========================================"
              exit 0
            else
              echo "  HTTP $HTTP_CODE - Retrying in 10s..."
              sleep 10
            fi
          done
          
          echo "‚ùå Health check failed"
          echo "Check logs: az containerapp logs show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --follow"
          exit 1
